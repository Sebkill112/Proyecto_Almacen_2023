@model IEnumerable<Proyecto_Almacen_T5DN_2023.Models.IngresoItem>

@{
    ViewData["Title"] = "DetalleIngreso";
}

<h1 class="text-center">DETALLE DEL INGRESO</h1>

<p>
    <a asp-action="Portal" asp-controller="Ingreso" class="btn btn-primary">Seguir Agregando</a>
</p>
<hr />
<div>
<h3>Proveedor</h3>
<select asp-items="@ViewBag.proveedor" class="form-control" id="cbo_proveedor"></select>
</div>
<br />
<div>
<h3>Fecha de Ingreso</h3>
<input type="text" name="ven" class="form-control" value="@ViewBag.fecha" id="txtFecha" readonly />
</div>
<br />
<table class="table table-hover" id="tbDetalle">
    <thead class="table-dark">
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.idProducto)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.nombreProducto)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.cantidad)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.precio)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.monto)
            </th>
            <th></th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @{
            double total = 0;
        }
@foreach (var item in Model) {
            total += (double)(item.cantidad * item.precio);

        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.idProducto)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.nombreProducto)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.cantidad)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.precio)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.monto)
            </td>
                <td>
                    <input type="button" value="Editar" class="btn btn-warning btn-editar" data-bs-toggle="modal" data-bs-target="#modalEditarCantidad"/>
                </td>
            <td>
                @Html.ActionLink("delete", "delete", new { id=item.idProducto  })
            </td>
        </tr>
}
    </tbody>
    <tfoot>
        <tr></tr>
        <tr>
            <th colspan="10">Total</th>
            <th>@string.Format("{0:C}", total)</th>
        </tr>
    </tfoot>
</table>
<hr />
<br />
<div>
    <input type="button" value="FINALIZAR INGRESO" class="btn btn-success" id="btn-finalizar"/>
</div>
<!-- Modal -->
<div class="modal fade" id="modalEditarCantidad" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Editar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ID Producto : <label id="lbId"></label><br />
                Nombre : <label id="lbNombre"></label><br />
                Precio :<input type="text" id="txtPrecioEditar" /><br />
                Cantidad : <input type="text" id="txtCantidadEditar" /><br />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnAceptarCantidad">Aceptar</button>
            </div>
        </div>
    </div>
</div>



@section Scripts
		{
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        
            <script>

                $("#btn-finalizar").on("click",function(){
                   let DetalleIngreso = [];
                    let total = 0;
                    let dato = "";

                    $("#tbDetalle > tbody > tr").each(function(index,tr){
                      DetalleIngreso.push(
                            {
                        idProducto: parseInt($(tr).find("td:eq(0)").text()),
                                   cantidad:parseInt($(tr).find("td:eq(2)").text()),
                                    precioUnitario: parseFloat($(tr).find("td:eq(3)").text()),
                                    subtotal: parseFloat($(tr).find("td:eq(4)").text()),

                        }
                        )
                total = total + parseFloat($(tr).find("td:eq(4)").text())
                    })

                    var Ingreso = {
                idProveedor: $("#cbo_proveedor").val(),
                     fechaIngreso: $("#txtFecha").val(),
                     total:total,
                lstdetalleIngreso: DetalleIngreso
                
                    }

                    dato = JSON.stringify(Ingreso);

              

            jQuery.ajax({
                url: '@Url.Action("GuardarIngreso", "Ingreso")',
                type: "POST",
                data: {dato : dato},
                dataType: "json",
                success: function (data) {
                    
                    if(data.respuesta){
                        Swal.fire({
                            icon: 'success',
                            title: 'Ingreso Registrado',
                            showConfirmButton: false,
                            timer: 1500
                        })
                        window.location.href = '@Url.Action("Portal", "Ingreso")'
                    }

                }
            });

                })

                var col_IdProducto
                var col_nombre;
                var col_precio;
                var col_cantidad;
                var col_monto;
                $(document).on("click", ".btn-editar", function () {
                col_IdProducto = $(this).parents("tr").find("td")[0].innerHTML;
                col_nombre = $(this).parents("tr").find("td")[1].innerHTML;
                col_precio = $(this).parents("tr").find("td")[3].innerHTML;
                col_cantidad = $(this).parents("tr").find("td")[2].innerHTML;

                $("#lbId").text(col_IdProducto);
                $("#lbNombre").text(col_nombre);
                $("#txtPrecioEditar").val(col_precio.trim());
                $("#txtCantidadEditar").val(col_cantidad.trim());
                    });

        $(document).on("click", "#btnAceptarCantidad", function () {
            let cant,pre;
            pre = $("#txtPrecioEditar").val();
            cant = $("#txtCantidadEditar").val();

            var producto = {
                idProducto: $("#lbId").text().trim(),
                nombreProducto: $("#lbNombre").text().trim(),
                cantidad: cant,
                precio: pre,
                monto: cant * pre
            }
            dato = JSON.stringify(producto);
        
            console.log(dato);

            jQuery.ajax({
                url: '@Url.Action("Editar", "Ingreso")',
                type: "POST",
                data: { dato: dato },
                dataType: "json",
                success: function (response) {

                    if (response.respuesta) {

                        window.location.href = '@Url.Action("DetalleIngreso", "Ingreso")'
                        alert("Producto editado")
                    }
                

                }
            });

                });
                

            </script>
        
        }
